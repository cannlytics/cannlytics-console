<!doctype html>
<html>
<!--
  API Settings | Cannlytics Console
  Author: Keegan Skeate <keegan@cannlytics.com>
  Created: 5/9/2021
  Updated: 5/9/2021
-->
{% extends "cannlytics_console/console.html" %}
{% block console_body %}

  <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">

    <!-- Header-->
    {% include "cannlytics_console/components/notifications/breadcrumbs.html" with
      base_page="Settings"
      base_page_url="/settings"
      current_page="API"
    %}

    <div class="row">

      <div class="col col-md-6">

        <!-- Title  -->
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="fs-5 mb-0 lh-base">API Keys</h1>
            <button
              class="btn btn-sm bg-gradient-green text-white"
              onclick="showNewKeyForm();"
            >
              Add a key
            </button>
          </div>

        <!-- Table -->

          <!-- TODO: API key management -->
          <div id="key-table" style="height:500px; width:100%;" class="ag-theme-alpine"></div>

      </div><!-- End of column -->

      <!-- Options -->
      <div class="col">

        <!-- TODO: Create a key form -->
        <div
          id="new-key-form"
          class="card h-100 bg-transparent border-secondary rounded-3 shadow-hover px-0 py-2 d-none"
          style="max-width: 375px;"
        >
          <h4 class="f2-5 text-dark">New API Key</h4>
          <button
            class="btn btn-sm btn-light text-dark"
            onclick="hideNewKeyForm()"
          >
            Cancel
          </button>
        </div>

        <!-- Information -->
        <div
          id="key-information-form"
          class="card h-100 bg-transparent border-secondary rounded-3 shadow-hover px-0 py-2"
          style="max-width: 375px;"
        >
          <h4 class="f2-5 text-dark">Key Information</h4>

          <!-- TODO: Create and style key form -->

        </div>

      </div>

    </div><!-- End of row -->

  </main>

{% endblock console_body %}
{% block console_js %}

  <script type="text/javascript" charset="utf-8">

    function showNewKeyForm() {
      /*
       * Show the add new key form and hide the key information form.
       */
      document.getElementById('new-key-form').classList.remove('d-none');
      document.getElementById('key-information-form').classList.add('d-none');
    }


    function hideNewKeyForm() {
      /*
       * Show the add new key form and hide the key information form.
       */
      document.getElementById('new-key-form').classList.add('d-none');
      document.getElementById('key-information-form').classList.remove('d-none');
    }

    
    function onSelectionChanged() {
      /*
       * Show key details on selection.
       */
      var selectedRows = gridOptions.api.getSelectedRows();
      console.log('Selected:', selectedRows);
      //document.querySelector('#selectedRows').innerHTML =
      //  selectedRows.length === 1 ? selectedRows[0].athlete : '';
    };

    // specify the columns
    const columnDefs = [
      { field: 'name' },
      { field: 'created_at' },
      { field: 'expiration_at' },
      { field: 'permissions' },
    ];

    // let the grid know which columns to use
    const gridOptions = {
      columnDefs: columnDefs,
      defaultColDef: {
        flex: 1,
        minWidth: 100,
      },
      rowSelection: 'single',
      onSelectionChanged: onSelectionChanged,
    };

    // lookup the container we want the Grid to use
    const eGridDiv = document.querySelector('#key-table');

    // create the grid passing in the div to use together with the columns & data we want to use
    new agGrid.Grid(eGridDiv, gridOptions);
    cannlytics.theme.setTableTheme();

    // Fetch the row data and provide it to the Grid via the Grid API.
    console.log(cannlytics.settings);
    cannlytics.settings.getAPIKeys('{{ user.uid }}').then(function(data) {
      console.log('Retrieved data in the template:', data)
      gridOptions.api.setRowData(data);
    });

  </script>

{% endblock %}
</html>
